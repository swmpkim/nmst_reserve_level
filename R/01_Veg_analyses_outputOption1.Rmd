---
title: "Veg Analysis"
output: 
    html_document:
        toc: true
        toc_float: true
        toc_depth: 2
params: 
    file_code: "NIW"
---

<details>
<summary>General to-dos</summary>

To-dos:  

-  see sub-list in QAQC child Rmd  
-  show the list of reserve's choices (which species to highlight, which species represent ecotone invaders in each zone, etc.)    
-  make a script to install necessary packages, and a script to make sure packages are installed and loading  
-  general documentation on how a reserve can run this - will be a single script calling this .Rmd; actually should be easier for Reserves than SETr  

</details>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE,
                      error = TRUE)
```

```{r, message = FALSE, warning = FALSE}
# library(Hmisc)
library(emmeans)
library(multcomp)
library(multcompView)
library(lmerTest)
library(dplyr)
library(tidyr)
library(readxl)
library(stringr)
library(kableExtra)
library(DT)
library(ggplot2)


file_dat <- here::here("data", paste0(params$file_code, "_NMST.xlsx"))
file_specs <- here::here("metadata", paste0(params$file_code, "veg_specs.xlsx"))
```

```{r}
source(here::here("R", "sourced", "functions.R"))
```


```{r}
# read data, metadata, and analysis specifications
dat <- get_data(file_dat, cover_only = TRUE) # gets rid of density and height columns; keeps F_ columns
stn_tbl <- get_stn_table(file_dat)
stn_tbl <- stn_tbl %>% 
    mutate(PlotID_full = paste(SiteID, TransectID, PlotID, sep = "-"))
species_info <- get_species_info(file_dat)
eis <- get_ecotone_invaders(file = file_specs)
anaSpecs <- get_anaSpecs(file = file_specs)
anaSpec_list <- split(anaSpecs, anaSpecs$R_anaName)

# add some columns to dat
dat <- dat %>% 
    dplyr::mutate(Date = lubridate::decimal_date(lubridate::ymd(paste(Year, Month, Day, sep = "-"))),
                  Years_sinceStart = round(Date - min(Date), 4),
                  StTrns = paste(SiteID, TransectID, sep = "-"),
                  StTrnsPlt = paste(SiteID, TransectID, PlotID, sep = "-")) %>% 
    dplyr::relocate(c(Date, Years_sinceStart), .before = Year) %>% 
    dplyr::relocate(c(StTrns, StTrnsPlt), .after = PlotID)
```


```{r}
# clean up data but keep some remnants for QA/QC tables
unsampds <- find_unsampleds(dat)
# find suspect data for later reporting
# NEED TO MAKE FLAG VALUES FLEXIBLE
susps <- find_suspect_values(dat, "-3")


dat <- remove_suspect_values(dat, flags = c("-3"))  # remove suspect values. also removes F_columns.
dat <- remove_unsampleds(dat)  # should get rid of any dates where a plot was not sampled or was entirely rejected. 
dat <- na_to_0(dat)  # turn remaining NAs into 0s


dat <- join_zones(dat, stn_tbl)  # add vegetation zones to each row
dat_long <- dat %>%
    pivot_longer(-(Reserve:Notes),
                 names_to = "Species",
                 values_to = "Cover")
```

```{r}
# summarize species present
spp_summ <- 
    dat_long %>% 
    group_by(SiteID, Species) %>% 
    summarize(times_present = sum(Cover > 0),
              mean_cover = round(mean(Cover, na.rm = TRUE), 3),
              max_cover = round(max(Cover, na.rm = TRUE), 3)
              ) %>% 
    arrange(Species, SiteID)
```

```{r}
# attach EIR to data frame
EIR <- dat_long %>% 
    left_join(eis) %>% 
    mutate(Invader = case_when(is.na(Invader) ~ 0,
                               .default = 1),
           EI_Cover = Cover * Invader) %>% 
    group_by(Year, Month, Day, Reserve, SiteID, TransectID, PlotID) %>% 
    summarize(EIR = round(sum(EI_Cover) / sum(Cover), 5))
# confirmed at April TWG that denominator is total cover

dat <- left_join(dat, EIR)
```


```{r, message = FALSE}
# combine species  
top_5_mean <- lump_species(dat_long, "mean", 5)  # species with highest 5 overall means

top_3_mean <- lump_species(dat_long, "mean", 3) %>% 
    dplyr::mutate(Date = lubridate::decimal_date(lubridate::ymd(paste(Year, Month, Day, sep = "-"))),
                  Years_sinceStart = round(Date - min(Date), 4),
                  PlotID_full = paste(SiteID, TransectID, PlotID, sep = "-")) %>% 
    dplyr::relocate(c(PlotID_full, Date, Years_sinceStart), .before = Year)


top_3_wide <- top_3_mean %>% 
    pivot_wider(names_from = Species,
                values_from = Cover,
                values_fill = 0) %>% 
    group_by(PlotID_full) %>% 
    mutate()
```


# Exploration and QA/QC {.tabset}  

```{r, child = "sourced/001_QAQC.Rmd"}

```


# Summary Figures {.tabset}  

```{r, child = "sourced/002_Summary_Figures.Rmd"}

```


# Univariate Analyses {.tabset}  

```{r, child = "sourced/003_Univariate_Analyses.Rmd"}

```


# Multivariate Analyses {.tabset}  

```{r, child = "sourced/004_Multivariate_Analyses.Rmd"}

```


# Documentation   

<details><summary>R Session Info; click to expand</summary>

```{r}
sessionInfo()
```

</details>