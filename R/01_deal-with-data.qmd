---
title: "Data wrangling"
format: html
params:
    reserve: "GND"
---

## Setup  

```{r, warning = FALSE}
library(readxl)
library(tidyverse)

file_dat <- here::here("data", paste0(params$reserve, "_NMST.xlsx"))
file_specs <- here::here("metadata", paste0(params$reserve, "veg_metadata.xlsx"))

source(here::here("R", "functions.R"))
```

## Pull in different data frames  

```{r}
dat <- get_data(file_dat)
stn_tbl <- get_stn_table(file_dat)
species_info <- get_species_info(file_dat)
```

### Define Ecotone Invaders  

```{r}
ei_defs <- get_eis(file_specs)
```

### add Vegetation Zone to dat  

```{r}
dat <- join_zones(dat, stn_tbl)
```

## Clean data  

+  remove rows where all species are NA (plot not measured)  
+  turn other NAs into 0  
+  remove values where F_ column is -3  (do we need to worry about 1? maybe have some type of QAQC in the analysis specs file?)  

## Calculate group totals  

```{r}
cat_sums <- sum_spp_categories()
```

### Join to sampling info  

```{r}
dat_summ <- cbind(dat[, 1:which(names(dat) == "Notes")], cat_sums)
names(dat_summ)[which(is.na(names(dat_summ)))] <- "Other"
```

### Pivot longer for easier plotting  

```{r}
dat_summ2 <- dat_summ %>% 
    pivot_longer(-(Reserve:Notes),
                 names_to = "Group",
                 values_to = "Cover")
```

Need to do something about NMST abiotic categories, unknown species, unvegetated, etc.  

Probably want data frames by:  

-  species (original)  
-  vegetation group  
-  with custom metrics  


## Plot groups through time  


```{r}
plot_through_time(data = dat_summ2, group = Group, panels = Vegetation_Zone) + ggtitle("By Zone")
```

```{r}
plot_through_time(data = dat_summ2, group = Group, panels = SiteID) + ggtitle("By Site")
```

```{r}
plot_through_time(data = dat_summ2, group = Vegetation_Zone, panels = Group) + ggtitle("By Species Group")
```


Test that function out on raw species data  

Too many species (but this is why we had Reserves identify which ones are most important)  

```{r}
# dat_long <- dat %>% 
#     select(-starts_with("F"),
#            -starts_with("Average Canopy Height"),
#            -starts_with("Density")) %>% 
#     pivot_longer(-(Reserve:Notes),
#                  names_to = "Species",
#                  values_to = "Cover")
# 
# plot_through_time(data = dat_long,
#           group = Species,
#           panels = Vegetation_Zone)
```

## Plot overall  

(same as above, just not by zone or site - all on one)  

```{r}
ggplot(dat_summ2, aes(x = Year, y = Cover, 
                     group = Group, color = Group, fill = Group)) +
        geom_point() +
        geom_smooth(method = "loess", se = FALSE)
```



***  
***  

# Alternate - long first  

Pivot longer, then add in zones, species groups, and Ecotone Invaders  

```{r}
dat2 <- get_data(file_dat)

dat_long <- dat2 %>% 
    select(-starts_with("F"),
           -starts_with("Average Canopy Height"),
           -starts_with("Maximum Canopy Height"),
           -starts_with("Density")) %>%
    pivot_longer(-(Reserve:Notes),
                 names_to = "Species",
                 values_to = "Cover")
```


## Add zones  

```{r}
dat_long2 <- join_zones(dat_long, stn_tbl)
```



