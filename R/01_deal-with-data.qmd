---
title: "Data wrangling"
format: html
---

## Setup  

```{r}
library(readxl)
library(tidyverse)

file_dat <- here::here("data", "GND_NMST.xlsx")
file_specs <- here::here("metadata", "GNDveg_metadata.xlsx")

source(here::here("R", "functions.R"))
```

## Pull in different data frames  

```{r}
dat <- get_data(file_dat)
stn_tbl <- get_stn_table(file_dat)
species_info <- get_species_info(file_dat)
```


### add Vegetation Zone to dat  

should probably make this a function  


```{r}
zones_to_join <- stn_tbl[, c("Reserve", "SiteID", "TransectID", "PlotID", "Vegetation_Zone")]

dat <- dplyr::left_join(dat, zones_to_join) %>% 
    relocate(Vegetation_Zone, .before = SiteID)
```

## Clean data  

+  remove rows where all species are NA (plot not measured)  
+  turn other NAs into 0  
+  remove values where F_ column is -3  (do we need to worry about 1? maybe have some type of QAQC in the analysis specs file?)  

## Calculate group totals  

```{r}
cat_sums <- sum_all_categories()
```

### Join to sampling info  

```{r}
dat_summ <- cbind(dat[, 1:which(names(dat) == "Notes")], cat_sums)
names(dat_summ)[which(is.na(names(dat_summ)))] <- "Other"
```

### Pivot longer for easier plotting  

```{r}
dat_summ2 <- dat_summ %>% 
    pivot_longer(-(Reserve:Notes),
                 names_to = "Group",
                 values_to = "Cover")
```

Need to do something about NMST abiotic categories, unknown species, unvegetated, etc.  

Probably want data frames by:  

-  species (original)  
-  vegetation group  
-  with custom metrics  


## Plot groups through time  


```{r}
plot_through_time(data = dat_summ2, group = Group, panels = Vegetation_Zone)
```

```{r}
plot_through_time(data = dat_summ2, group = Group, panels = SiteID)
```


Test that function out on raw species data  

Too many species (but this is why we had Reserves identify which ones are most important)  

```{r}
dat_long <- dat %>% 
    select(-starts_with("F"),
           -starts_with("Average Canopy Height"),
           -starts_with("Density")) %>% 
    pivot_longer(-(Reserve:Notes),
                 names_to = "Species",
                 values_to = "Cover")

plot_through_time(data = dat_long,
          group = Species,
          panels = Vegetation_Zone)
```

