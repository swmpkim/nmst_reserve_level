---
title: ''
output: html_document
---

Tasks to address from analysis plan:  

+  Create summary tables (table (PlotID,SiteID); table (PlotID,Year))  
+  QAQC flag summary - make it obvious if there are any 1s or -3s in the dataset  
+  number of rows missing data (plots not measured)  
+  Something to check percent cover standardization (e.g., max. cover).  


## Tables  

### Plots/dates without samples  

There were **`r nrow(find_unsampleds(dat))` rows** with no data. These rows were removed from the dataset before further processing. If rows were removed, relevant information is in a table below.   

```{r}
if(nrow(find_unsampleds(dat)) > 0){
    find_unsampleds(dat) %>% 
        DT::datatable(rownames = FALSE,
                      caption = "Plots/Dates with no sampling information")
}
```


```{r}
# get rid of unsampled rows and turn remaining NAs into 0s
dat <- remove_unsampleds(dat)  # get rid of rows full of NA
dat <- na_to_0(dat)  # turn remaining NAs into 0s
```


### Data flagged suspect or reject  



```{r, message = FALSE}

dat <- remove_suspect_values(dat, flags = c("-3"))  # remove suspect values

# may need to re-remove rows of NA values, in case removing suspect values turned a whole row into NAs
```




```{r, message = FALSE}
dat <- join_zones(dat, stn_tbl)  # add vegetation zones to each row

dat_long <- dat %>%
    pivot_longer(-(Reserve:Notes),
                 names_to = "Species",
                 values_to = "Cover")
```


Don't forget to make flags to remove some sort of user input in a spreadsheet, and modify function to use user's input (rather than my hard-coded 1 and -3)  


```{r}
# species group totals 
cat_sums <- sum_spp_categories(data = dat)

# join to sampling info, then pivot longer for easier plotting
dat_summ <- cbind(dat[, 1:which(names(dat) == "Notes")], cat_sums)
names(dat_summ)[which(is.na(names(dat_summ)))] <- "Other"

dat_summ_long <- dat_summ %>% 
    pivot_longer(-(Reserve:Notes),
                 names_to = "Group",
                 values_to = "Cover")


```


Need to do something about NMST abiotic categories, unknown species, unvegetated, etc.  

Probably want data frames by:  

-  species (original)  
-  vegetation group  
-  with custom metrics  

```{r, message = FALSE}
# combine species  
top_5_mean <- lump_species(dat_long, "mean", 5)  # species with highest 5 overall means
top_5_nonzero <- lump_species(dat_long, "nonzero", 5)  # species with 5 highest "present"

```


```{r, message = FALSE}
# attach EIR to data frame
dat_long <- dat_long %>% 
    left_join(eis) %>% 
    mutate(Invader = case_when(is.na(Invader) ~ 0,
                               .default = 1))

EIR <- dat_long %>% 
    select(Reserve:PlotID,
           Species,
           Cover,
           Invader) %>% 
    mutate(EI_Cover = Cover * Invader) %>% 
    group_by(Year, Month, Day, Reserve, SiteID, TransectID, PlotID) %>% 
    summarize(EIR = round(sum(EI_Cover) / sum(Cover), 5))
# confirmed at April TWG that denominator is total cover

dat <- left_join(dat, EIR)
```






### Sites and sample dates  

```{r}
dat2 <- dat %>% 
    mutate(SiteTransectPlot = paste(SiteID, TransectID, PlotID, sep = "-"))

table(dat2$SiteTransectPlot, dat2$Year) %>%
    kable(caption = "# samples at each plot in each year") %>%
    kable_styling("striped") %>%
    scroll_box(width = "600px", height = "300px")

# dat2 %>%
#     group_by(SiteTransectPlot, Year) %>% 
#     summarize(count = n()) %>% 
#     arrange(SiteTransectPlot, Year) %>% 
#     pivot_wider(names_from = Year, values_from = count, values_fill = 0) %>% 
#     DT::datatable(caption = "# samples at each plot in each year")
```

### Species  

```{r, message = FALSE}
spp_summ <- 
    dat_long %>% 
    group_by(SiteID, Species) %>% 
    summarize(times_present = sum(Cover > 0),
              mean_cover = round(mean(Cover, na.rm = TRUE), 3),
              max_cover = round(max(Cover, na.rm = TRUE), 3)
              ) %>% 
    arrange(Species, SiteID)

# kable(spp_summ) %>% 
#     kable_styling("striped") %>% 
#     scroll_box(width = "500px", height = "300px")

DT::datatable(spp_summ, 
              rownames = FALSE,
              caption = "Species cover and presence per site, across all years. This table is sortable and searchable.")
```




```{r}

```


## Graphics  

```{r}

```

