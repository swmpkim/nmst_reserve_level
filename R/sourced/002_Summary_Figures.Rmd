---
title: ''
output: html_document
---

## Averaged Stacked Bar Charts  

```{r}

```


## Spatial Bar Charts  

Brook's code - uses `Hmisc::subplot()`   

```{r}
#library(Hmisc)
# plot(c(min(stn_info$Long)-.0005,max(stn_info$Long)+.0015),c(min(stn_info$Lat)-.0005,max(stn_info$Lat)+.001),
#      type="n",bty="n",xlab="Longitude",ylab="Latitude",main="DELSJR (DARK = Spartina, MED = Bare, LIGHT = Other)")
# 
# for (plt in unique(dat$PlotID)){
#   dat_plt <- dat[dat$PlotID==plt,]
#   yrs <- dat_plt$Elapsed_Yrs
#   lat <- stn_info[stn_info$PlotID==plt,]$Lat
#   long <- stn_info[stn_info$PlotID==plt,]$Long
#   subplot(barplot( t(as.matrix(dat_plt[,48:50])),names.arg = rep("",4),xlab = "",axes=FALSE),
#           x=c(long-.0005,long+.0005),y=c(lat-.0005,lat+.0005))
# }

```

Pull out top 3 species; will get 3 + other  

-  Will need to figure out how to do this based on species the reserve chose  
-  Need to figure out what the different colors mean  

```{r, message = FALSE}
top_3_mean <- lump_species(dat_long, "mean", 3) %>% 
    dplyr::mutate(Date = lubridate::decimal_date(lubridate::ymd(paste(Year, Month, Day, sep = "-"))),
                  Years_sinceStart = round(Date - min(Date), 4),
                  PlotID_full = paste(SiteID, TransectID, PlotID, sep = "-")) %>% 
    dplyr::relocate(c(PlotID_full, Date, Years_sinceStart), .before = Year)


top_3_wide <- top_3_mean %>% 
    pivot_wider(names_from = Species,
                values_from = Cover,
                values_fill = 0) %>% 
    group_by(PlotID_full) %>% 
    mutate()


stn_tbl <- stn_tbl %>% 
    mutate(PlotID_full = paste(SiteID, TransectID, PlotID, sep = "-"))
```

One plot per Site; only showing 4 evenly spaced samples.  


Adjusted x and y offsets to be calculated based on the range for each site - DEL-SJR's params didn't work at NIW and GND.  

-  For DEL-SJR, long +/- 0.0005; lat +/- 0.0015  
-  range of long was .442 to .430 = .012. long offset about 4% (0.042)  
-  range of lat about .078 to .090 = 0.012  lat offset 12.5%.  
-  using 5% for long and 12.5% for lat (for now).  

```{r}
for(st in unique(stn_tbl$SiteID)){
    
    # subset to the site
    stn_tmp <- stn_tbl[stn_tbl$SiteID == st, ]
    
    long_offset <- (max(stn_tmp$Long) - min(stn_tmp$Long)) * 0.05
    lat_offset <- (max(stn_tmp$Lat) - min(stn_tmp$Lat)) * 0.125
    
    # blank plot canvas
    plot(c(min(stn_tmp$Long) - long_offset,
           max(stn_tmp$Long) + long_offset),
         c(min(stn_tmp$Lat) - lat_offset,
           max(stn_tmp$Lat) + lat_offset),
         type = "n",
         bty = "n",
         xlab = "Longitude", ylab = "Latitude",
         main = paste(params$file_code, st))
    
    # subset the lumped data to the single site
    dat_tmp <- top_3_wide[top_3_wide$SiteID == st, ]
    
 

    # loop through each plot at the site
    # make a barplot of the top 3 species + other
    # and add as subplot to the blank canvas, based on lat/long
    for (plt in unique(dat_tmp$PlotID_full)){
        
        dat_plt <- dat_tmp[dat_tmp$PlotID_full==plt, ]
        yrs <- dat_plt$Years_sinceStart
            
        # subset the years: min, max, and as close as possible to the difference/3  

        un_yrs <- unique(yrs)
        div <- (max(un_yrs) - min(un_yrs)) / 3
        divs_to_keep <- c(min(un_yrs) + div,
                          max(un_yrs) - div)
        

        # figure out what to keep by finding the closest actual measurement to each, using absolute values
        keeps2 <- un_yrs[which(abs(un_yrs - divs_to_keep[1]) == min(abs(un_yrs - divs_to_keep[1])))]
        keeps3 <- un_yrs[which(abs(un_yrs - divs_to_keep[2]) == min(abs(un_yrs - divs_to_keep[2])))]

        keeps <- c(min(un_yrs), keeps2, keeps3, max(un_yrs))
        
        # re-subset the data frame to only those years
        dat_plt <- dat_plt[dat_plt$Years_sinceStart %in% keeps, ]
        yrs <- dat_plt$Years_sinceStart
        
        lat <- stn_tmp[stn_tmp$PlotID_full==plt, ]$Lat
        long <- stn_tmp[stn_tmp$PlotID_full==plt, ]$Long
        subplot(barplot( t(as.matrix(dat_plt[,(ncol(dat_plt)-3):ncol(dat_plt)])),  # last 4 columns are the top 3 species + Other
                         xlab = "",
                         axes=FALSE),
                x = c(long - long_offset, long + long_offset),
                y = c(lat - lat_offset, lat + lat_offset))  
    }
}
```


### Attempt using ggplot.  

Use long format data frame for this.  

Tutorial here: https://www.r-bloggers.com/2019/02/plots-within-plots-with-ggplot2-and-ggmap/  

Want to add all these additional plots as `ggplotGrob`s using `annotation_custom`. Guess I need to make all the plots first??? So I'll need a data frame or list of the grobs, xmin and max values, and ymin and max values for them......

```{r}
# p1 + annotation_custom(ggplotGrob(p2), xmin = 1, xmax = 3, 
#                        ymin = -0.3, ymax = 0.6)
```




```{r}

palcols <- RColorBrewer::brewer.pal(4, "Paired")
names(palcols) <- unique(top_3_mean$Species)

# add species into station table for the sole purpose of generating a legend.  
stn_tbl$Species <- rep_len(unique(top_3_mean$Species), length.out = nrow(stn_tbl))

for(st in unique(stn_tbl$SiteID)){
    
    # subset to the site
    stn_tmp <- stn_tbl[stn_tbl$SiteID == st, ]
    
    long_offset <- (max(stn_tmp$Long) - min(stn_tmp$Long)) * 0.05
    lat_offset <- (max(stn_tmp$Lat) - min(stn_tmp$Lat)) * 0.125
    
    # blank plot canvas
    base <- ggplot(stn_tmp, aes(x = Long, y = Lat, 
                                group = Species,
                                fill = Species)) +
        geom_col(na.rm = TRUE) +  # necessary to make legend show up
        labs(title = paste(params$file_code, st),
             x = "Longitude",
             y = "Latitude") +
        scale_x_continuous(limits = c(min(stn_tmp$Long) - long_offset, max(stn_tmp$Long) + long_offset)) +
        scale_y_continuous(limits = c(min(stn_tmp$Lat) - lat_offset, max(stn_tmp$Lat) + lat_offset)) +
        scale_fill_manual(values = palcols) +
        theme_bw() +
        theme(legend.position = "right")
    
    
    # subset the lumped data to the single site
    dat_tmp <- top_3_mean[top_3_mean$SiteID == st, ]
    
 

    # loop through each plot at the site
    # make a barplot of the top 3 species + other
    # and add as subplot to the blank canvas, based on lat/long
    for (plt in unique(dat_tmp$PlotID_full)){
        
        dat_plt <- dat_tmp[dat_tmp$PlotID_full==plt, ]
        yrs <- dat_plt$Years_sinceStart
            
        # subset the years: min, max, and as close as possible to the difference/3  

        un_yrs <- unique(yrs)
        div <- (max(un_yrs) - min(un_yrs)) / 3
        divs_to_keep <- c(min(un_yrs) + div,
                          max(un_yrs) - div)
        

        # figure out what to keep by finding the closest actual measurement to each, using absolute values
        keeps2 <- un_yrs[which(abs(un_yrs - divs_to_keep[1]) == min(abs(un_yrs - divs_to_keep[1])))]
        keeps3 <- un_yrs[which(abs(un_yrs - divs_to_keep[2]) == min(abs(un_yrs - divs_to_keep[2])))]

        keeps <- c(min(un_yrs), keeps2, keeps3, max(un_yrs))
        
        # re-subset the data frame to only those years
        dat_plt <- dat_plt[dat_plt$Years_sinceStart %in% keeps, ]

        # make the subplot
        subplo <- ggplotGrob(ggplot(dat_plt) +
                                 geom_col(aes(x = as.factor(Years_sinceStart),
                                              y = Cover,
                                              fill = Species),
                                          # width = 0.8,
                                          position = "stack",
                                          show.legend = FALSE) +
                                 scale_fill_manual(values = palcols) +
                                 theme_void() + 
                                 theme(panel.border = element_rect(linetype = "dashed", fill = NA)))
        
        # get coordinates for subplot
        lat <- stn_tmp[stn_tmp$PlotID_full==plt, ]$Lat
        long <- stn_tmp[stn_tmp$PlotID_full==plt, ]$Long
        
        # add the subplot to the graph
        
        base <- base + 
            annotation_custom(grob = subplo,
                              xmin = long - long_offset,
                              xmax = long + long_offset,
                              ymin = lat - lat_offset,
                              ymax = lat + lat_offset)
         
    }
    print(base)
}
```