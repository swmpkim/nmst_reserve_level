---
output: html_document
---


```{r}
mod_nested_full <- lmer(resp ~ Years_sinceStart*Vegetation_Zone + (1|SiteID/TransectID/PlotID),
                   data = dat_univar)

mod_nested_siteplot <- lmer(resp ~ Years_sinceStart*Vegetation_Zone + (1|SiteID/StTrnsPlt),
                   data = dat_univar)

mod_nested_trns <- lmer(resp ~ Years_sinceStart*Vegetation_Zone + (1|StTrns/PlotID),
                   data = dat_univar)

mod_plts <- lmer(resp ~ Years_sinceStart*Vegetation_Zone + (1|StTrnsPlt),
                   data = dat_univar)
```


#### Model errors, if any, will show up here  

 

```{r}
# allow for models that have errored and 
# add models that did work to a list to pull out results

mods <- list()


if(exists("mod_nested_full", inherits = FALSE)){
    mods[["fully nested"]] <- mod_nested_full
} else {
    cat("fully nested model errored")
}

if(exists("mod_nested_siteplot", inherits = FALSE)){
    mods[["site/plot"]] <- mod_nested_siteplot
} else {
    cat("site/plot model errored")
}


if(exists("mod_nested_trns", inherits = FALSE)){
    mods[["transect/plot"]] <- mod_nested_trns
} else {
    cat("transect/plot model errored")
}


if(exists("mod_plts", inherits = FALSE)){
    mods[["plots only"]] <- mod_plts
} else {
    cat("plots only random effect model errored")
}
```


```{r}
trends <- purrr::map(mods, function(x) get_trends(x))
trends_df <- bind_rows(trends, .id = "model") %>% 
    mutate(model = forcats::as_factor(model))
```



```{r, warning = FALSE, message = FALSE}
# Pull out marginal and conditional R^2 for mixed models and add columns to df  

rsqds <- purrr::map(mods, function(x) as.data.frame(MuMIn::r.squaredGLMM(x)))
rsqds_df <- bind_rows(rsqds, .id = "model") %>% 
    mutate(model = forcats::as_factor(model))
trends_df <- left_join(trends_df, rsqds_df)
```



### Numerical effects  

For simplicity, using model where plot is the only random effect.

```{r}
if(exists("mod_plts")){
    mod_anov <- anova(mod_plts, ddf = "Kenward-Roger")
    tidied <- broom::tidy(mod_anov)
    sig_int <- tidied[tidied$term == "Years_sinceStart:Vegetation_Zone", "p.value"] < 0.05
    mod_trnds <- data.frame(emtrends(mod_plts, 
                                     pairwise ~ Vegetation_Zone, 
                                     var = "Years_sinceStart")$emtrends)
    
    
}

kbl_nmst(mod_anov, 
         caption = paste("Type III Analysis of Variance Table, using Kenward-Rogers method:", respn),
         digits = c(4, 4, 1, 2, 2, 4))  

cat("\n \n \n")

kbl_nmst(mod_trnds, 
         digits = c(4, 4, 4, 2, 4, 4), 
         col.names = c("Veg Zone", "Trend (per year)",
                       "SE", "df", "CI lower", "CI upper"),
         caption = paste("Estimated marginal slopes (change per year for each zone):", respn)) 

univar_outputs[[respn]] <- mod_trnds
```


### Graphs  

```{r, warning = FALSE, message = FALSE}
if(exists("mod_plts")){
    pdf <- emmip(mod_plts, Vegetation_Zone ~ Years_sinceStart,
                 cov.reduce = range,
                 linearg = list(size = 1), CIs = TRUE,
                 plotit = FALSE)
    
    p1 <- ggplot() +
        geom_line(data = pdf, aes(x = Years_sinceStart,
                                  y = yvar,
                                  col = Vegetation_Zone,
                                  linetype = Vegetation_Zone),
                  linewidth = 0.8) +
        labs(title = paste("Model Predicted Values:", respn),
             x = "Years elapsed", 
             y = paste("Predicted", respn),
             col = "Vegetation Zone",
             linetype = "Vegetation Zone") +
        theme_bw()
    
    
    
    p2 <- ggplot() +
        geom_jitter(data = dat_univar, aes(x = Years_sinceStart, y = resp,
                                     col = Vegetation_Zone),
                    alpha = 0.7) +
        geom_line(data = pdf, aes(x = Years_sinceStart,
                                  y = yvar,
                                  col = Vegetation_Zone,
                                  linetype = Vegetation_Zone),
                  linewidth = 0.8) +
        facet_wrap(~Vegetation_Zone) +
        theme_bw() +
        labs(x = "Years elapsed",
             y = respn) +
        theme(legend.position = "none")
    
    print(p1)
    # print(p2)
    
    
    model <- mod_plts
    predicted <- estimate_expectation(model, data = "grid")
    p3 <- plot(predicted, ribbon = list(alpha = 0.2),
               point = list(alpha = 0.5),
               line = list(alpha = 0.9, size = 0.8)) + 
        theme_bw() +
        facet_wrap(~Vegetation_Zone) + 
        labs(title = paste("Predicted response:", respn),
             subtitle = "predictions and CIs generated by easystats packages",
             x = "Years elapsed",
             y = respn) +
        theme(legend.position = "none")
    
    print(p3)
}
```


### Contrasts plot  

For the model with transect/plot nesting. If the interaction between vegetation zone and time was significant (p < 0.05), letters are used to represent groups of slopes that are not significantly different (via pairwise comparisons). If the interaction was not significant, this plot represents the marginal slopes but no letters are used.

Some notes from the function. Kenward-Roger method used to estimate denominator degrees of freedom. Confidence level used: 0.95. p-value adjustment: Tukey. alpha = 0.05.  

"If two or more means share the same grouping symbol,
      then we cannot show them to be different.
      But we also did not show them to be the same."

```{r, fig.height = 5, fig.width = 6}
if(exists("mod_plts")){
    trnds <- emtrends(mod_plts, 
                  pairwise ~ Vegetation_Zone, 
                  var = "Years_sinceStart")
    mod_cld <- cld(trnds, Letters = letters) %>% 
        mutate(.group = str_trim(.group))
    
    p <- ggplot(mod_cld, aes(x = reorder(Vegetation_Zone, Years_sinceStart.trend),
                             y = Years_sinceStart.trend,
                             label = .group,
                             color = Vegetation_Zone)) +
        geom_hline(yintercept = 0) +
        geom_pointrange(aes(ymin = lower.CL, 
                            ymax = upper.CL),
                        linewidth = 0.8) +
        labs(title = paste("Rate of change in", respn, "by zone"),
             x = "Vegetation Zone",
             y = "change per year") +
        theme_bw() +
        theme(legend.position = "none")
    
    if(sig_int){
        p <- p +
            geom_text(aes(y = max(mod_cld$upper.CL)),
                      nudge_y = max(mod_cld$upper.CL)/10,
                      color = "black")
    }
    print(p)
}
```

### Comparing nesting structures  

#### Singular Models  

```{r}
if(exists("mod_nested_full")){check_singularity(mod_nested_full)}
if(exists("mod_nested_siteplot")){check_singularity(mod_nested_siteplot)}
if(exists("mod_nested_trns")){check_singularity(mod_nested_trns)}
if(exists("mod_plts")){check_singularity(mod_plts)}
```

#### Model Structure Comparisons  


```{r}
to_print <- trends_df %>% 
    mutate(across(Years_sinceStart.trend:R2c, function(x) round(x, 4)),
           df = round(df, 2)) %>% 
    arrange(Vegetation_Zone, model) %>% 
    rename(TrendPerYear = Years_sinceStart.trend) %>% 
    relocate(Vegetation_Zone)
    
kbl(to_print) %>% 
    kable_styling("striped") %>%
    scroll_box(width = "600px", height = "300px") 
```  

```{r}
ggplot(to_print, aes(col = model)) +
    geom_errorbarh(aes(y = model, xmin = lower.CL, xmax = upper.CL)) +
    geom_point(aes(y = model, x = TrendPerYear)) +
    facet_wrap(~ Vegetation_Zone, scales = "free_x") +
    labs(title = paste(respn, " - coefficients of different model structures"), 
         x = "Trend per year",
         y = "model") +
    theme_bw() +
    theme(legend.position = "none")
```



#### Random effects by plot  

Drawn from the model where only plot is used as a random effect.  

```{r, fig.width = 8, fig.height = 7}
stn_tbl_b <- stn_tbl %>% filter(PlotID_full %in% dat_univar$StTrnsPlt)

fields::quilt.plot(x = stn_tbl_b$Long, y = stn_tbl_b$Lat, z = unlist(ranef(mod_plts)$StTrnsPlt),
                   nx = 100, ny = 100)
```

```{r}
# cleanup before next response var
rm(p, p1, p2, p3,
   mod_nested_full, mod_nested_siteplot,
   mod_nested_trns, mod_plts,
   mods,
   trends, trends_df,
   rsqds, rsqds_df, 
   to_print,
   trnds, mod_cld,
   mod_anov, tidied, sig_int, pdf)
```

