---
output: html_document
---

```{r, results = 'asis'}
if(length(unique(dat_univar$Vegetation_Zone)) > 1){
    
    mod_plts <- lmer(resp ~ Years_sinceStart*Vegetation_Zone + (1|StTrnsPlt),
                     data = dat_univar)
    
    modyes <- exists("mod_plts", inherits = FALSE)
    modSingleZone <- FALSE
    
    cat("\n\n **The current file contains multiple vegetation zones, and vegetation zone will be one of the predictors in the statistical model.** \n\n")
    
} else {
    
    mod_singleZone <- lmer(resp ~ Years_sinceStart + (1|StTrnsPlt),
                     data = dat_univar)
    modyes <- FALSE
    modSingleZone <- TRUE
    
    cat("\n\n **The current file only contains one vegetation zone. Results presented apply to this zone.** \n\n")
}
```

```{r, warning = FALSE, error = FALSE, results = "asis"}
    # if the model with both time and veg zone ran, pull out all the info to report in the sections below

if(exists("mod_plts", inherits = FALSE)){

    cat("\n")
    
    # tables
    trends_df <- get_trends(mod_plts)
    rsqds <- as.data.frame(MuMIn::r.squaredGLMM(mod_plts))
    
    mod_anov <- anova(mod_plts, ddf = "Kenward-Roger")
    tidied <- broom::tidy(mod_anov)
    sig_int <- tidied[tidied$term == "Years_sinceStart:Vegetation_Zone", "p.value"] < 0.05
    mod_trnds <- estimate_slopes(mod_plts, trend = "Years_sinceStart",
                                 by = "Vegetation_Zone")
    
    # save outputs
    univar_outputs[[respn]] <- mod_trnds
    
    # plots to print
    pdf <- emmip(mod_plts, Vegetation_Zone ~ Years_sinceStart,
                 cov.reduce = range,
                 linearg = list(size = 1), CIs = TRUE,
                 plotit = FALSE)
    
    p1 <- ggplot() +
        geom_line(data = pdf, aes(x = Years_sinceStart,
                                  y = yvar,
                                  col = Vegetation_Zone,
                                  linetype = Vegetation_Zone),
                  linewidth = 0.8) +
        scale_color_manual(values = palcols_zones) +
        labs(title = paste("Model Predicted Values:", respn),
             x = "Years elapsed", 
             y = paste("Predicted", respn),
             col = "Vegetation Zone",
             linetype = "Vegetation Zone") +
        theme_bw()
    
 
    model <- mod_plts
    predicted <- estimate_expectation(model, data = "grid")
    p3 <- plot(predicted, ribbon = list(alpha = 0.2),
               point = list(alpha = 0.5),
               line = list(alpha = 0.9, size = 0.8)) + 
        theme_bw() +
        facet_wrap(~Vegetation_Zone) + 
        scale_color_manual(values = palcols_zones) +
        scale_fill_manual(values = palcols_zones) +
        labs(title = paste("Predicted response:", respn),
             subtitle = "predictions and CIs generated by easystats packages",
             x = "Years elapsed",
             y = respn) +
        theme(legend.position = "none")
    
} 
```

```{r}
# if the model with only time ran, pull out those results
if(exists("mod_singleZone", inherits = FALSE)){

    cat("\n")
    
    
    # tables
    coefTab <- as.data.frame(summary(mod_singleZone)$coefficients)
    ciTab <- as.data.frame(confint(mod_singleZone))
    names(ciTab) <- c("CIlow", "CIhigh")
    trends_df <- cbind(coefTab[2, ], ciTab[4, ] ) %>%  # this is different from the veg zone model
        relocate(c(CIlow, CIhigh), .after = `Std. Error`)
    rsqds <- as.data.frame(MuMIn::r.squaredGLMM(mod_singleZone))
    
    mod_anov <- anova(mod_singleZone, ddf = "Kenward-Roger")
    tidied <- broom::tidy(mod_anov)
    
    
    # save outputs
    univar_outputs[[respn]] <- trends_df
    
    # plots to print
    pdf <- emmip(mod_singleZone, ~ Years_sinceStart,
                 cov.reduce = range,
                 linearg = list(size = 1), CIs = TRUE,
                 plotit = FALSE)
    
    p1 <- ggplot() +
        geom_line(data = pdf, aes(x = Years_sinceStart,
                                  y = yvar),
                  col = "navy",
                  linewidth = 0.8) +
        labs(title = paste("Model Predicted Values:", respn),
             x = "Years elapsed", 
             y = paste("Predicted", respn)) +
        theme_bw()
 
    model <- mod_singleZone
    predicted <- estimate_expectation(model, data = "grid")
    p3 <- plot(predicted, ribbon = list(alpha = 0.2, fill = "navy"),
               point = list(alpha = 0.5, col = "navy"),
               line = list(alpha = 0.9, size = 0.8, col = "navy")) + 
        theme_bw() +
        labs(title = paste("Predicted response:", respn),
             subtitle = "predictions and CIs generated by easystats packages",
             x = "Years elapsed",
             y = respn) +
        theme(legend.position = "none")
    
} 
```

```{r}
# if one of the models ran, we'll print out results below. But if not, print this message:

if((modyes + modSingleZone) == 0){
    cat("### **This statistical model did not run.**")
    cat("\n \nPlease make sure the species or response variable is spelled and capitalized correctly, and that there is adequate data in the file to calculate a trend. \n \nIf that does not help, please copy the error message that appeared above when reaching out to someone else, as it may be useful.")
    
    printMod <- FALSE
} else {
    printMod <- TRUE
}

```


### Numerical effects  

```{r, eval = printMod, results = "asis"}

kbl_nmst(mod_anov, 
         caption = paste(respn, " - Type III Analysis of Variance Table, using Kenward-Rogers method"),
         digits = c(4, 4, 1, 2, 2, 4))  

cat("\n \n \n")
cat("\n \n \n")

if(modyes){
    kbl_nmst(mod_trnds[, -4], 
             digits = c(4, 4, 4, 3, 3, 1, 1, 4), 
             col.names = c("Veg Zone", "Trend (per year)",
                           "SE", "CI lower", "CI upper", "t",
                           "df", "p.val"),
             caption = paste(respn, " - Estimated marginal slopes (change per year for each zone)")) 
}

if(modSingleZone){
    kbl_nmst(trends_df, 
             digits = c(4, 4, 3, 3, 1, 1, 4), 
             col.names = c("Trend (per year)",
                           "SE", "CI lower", "CI upper", "df",
                           "t", "p.val"),
             caption = paste(respn, " - Estimated trend")) 
}

cat("\n \n \n")

cat("Marginal R^2 represents the variance explained by the fixed effects. Conditional R^2 represents the variance explained by the entire model, which includes both fixed and random effects.")

kbl_nmst(rsqds,
         caption = paste(respn, " - Margn'l and Cond'l R^2 values"),
         digits = 3)

cat("\n \n \n")
cat("\n \n \n")
```


### Graphs  

```{r, warning = FALSE, message = FALSE, eval = printMod}
print(p1)
print(p3)
```


### Contrasts plot  

```{r, results = 'asis'}
if(length(unique(dat_univar$Vegetation_Zone)) <= 1){
    cat("\n\n **This section only applies to files where more than one vegetation zone is present. Your file only had one vegetation zone, and it was analyzed above.** \n\n")
}
```


If the interaction between vegetation zone and time was significant (p < 0.05), letters are used to represent groups of slopes that are not significantly different (via pairwise comparisons). If the interaction was not significant, this plot represents the marginal slopes but no letters are used.

Some notes from the function. Kenward-Roger method used to estimate denominator degrees of freedom. Confidence level used: 0.95. p-value adjustment: Tukey. alpha = 0.05.  

"If two or more means share the same grouping symbol,
      then we cannot show them to be different.
      But we also did not show them to be the same."

```{r, fig.height = 5, fig.width = 6, eval = modyes}
trnds <- emtrends(mod_plts, 
                  pairwise ~ Vegetation_Zone, 
                  var = "Years_sinceStart")
mod_cld <- cld(trnds, Letters = letters) %>% 
    mutate(.group = str_trim(.group))

mod_cld$Vegetation_Zone <- factor(mod_cld$Vegetation_Zone, levels = zone_factor)

p <- ggplot(mod_cld, aes(x = reorder(Vegetation_Zone, Years_sinceStart.trend),
                         y = Years_sinceStart.trend,
                         label = .group,
                         color = Vegetation_Zone)) +
    geom_hline(yintercept = 0) +
    geom_pointrange(aes(ymin = lower.CL, 
                        ymax = upper.CL),
                    linewidth = 0.8) +
    scale_color_manual(values = palcols_zones) +
    labs(title = paste("Rate of change in", respn, "by zone"),
         x = "Vegetation Zone, low to high rate of change",
         y = "change per year") +
    theme_bw() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 40, hjust = 1, vjust = 1))

if(sig_int){
    p <- p +
        geom_text(aes(y = max(mod_cld$upper.CL)),
                  nudge_y = max(mod_cld$upper.CL)/10,
                  color = "black")
}
print(p)
```

Same plot, but x-axis goes from lowest to highest zone.    

```{r, fig.height = 5, fig.width = 6, eval = modyes}
p <- ggplot(mod_cld, aes(x = Vegetation_Zone,
                         y = Years_sinceStart.trend,
                         label = .group,
                         color = Vegetation_Zone)) +
    geom_hline(yintercept = 0) +
    geom_pointrange(aes(ymin = lower.CL, 
                        ymax = upper.CL),
                    linewidth = 0.8) +
    scale_color_manual(values = palcols_zones) +
    labs(title = paste("Rate of change in", respn, "by zone"),
         x = "Vegetation Zone, low to high elevation",
         y = "change per year") +
    theme_bw() +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 40, hjust = 1, vjust = 1))

if(sig_int){
    p <- p +
        geom_text(aes(y = max(mod_cld$upper.CL)),
                  nudge_y = max(mod_cld$upper.CL)/10,
                  color = "black")
}
print(p)
```



```{r, eval = modyes}
check_singularity(mod_plts)
```


```{r, eval = modyes}
# cleanup before next response var
rm(p, p1, p3,
   mod_plts,
   trends_df,
   rsqds,  
   trnds, mod_cld,
   mod_anov, tidied, sig_int, pdf)
```

```{r, eval = modSingleZone}
# cleanup before next response var
rm(p, p1, p3,
   trends_df,
   rsqds,
   mod_anov, tidied, pdf)
```