---
title: ''
output: html_document
---

```{r}
library(vegan)
library(ggrepel)
library(ggiraph)
```

## About  

These tabs are the multivariate analyses.  

**NOTE:** during development, I'm only using columns identified by reserves to highlight in their multivariate analyses. I'm not sure it's okay to ignore everything else - we probably should combine into Namaste categories and maybe some other things - so we need to discuss what the actual data frame will look like. The identified columns will still be the only ones that show up on species arrows and the like though.  

Need to write up some explanation of what we did statistically. Also identify which factors the reserve was interested in showing on NMDS plots.

```{r show-userChoice-multivar, results = 'asis'}
cat(paste("*", anaSpec_list$multivar$Choice), sep="\n")
```

```{r mod-multivar-df}
# widen out the univar data frame
# it's grouped appropriately for these analyses  
dat_multivar <- anaSpec_dfs$multivar %>% 
    pivot_wider(names_from = Species_or_Group,
                values_from = Cover)

# join EIR - use a join because might not be in same order
EIR_df <- dat %>% 
    select(StTrnsPlt, Year, Month, Day, EIR)
dat_multivar <- left_join(dat_multivar, EIR_df)

# can join any other metrics here - e.g. richness, diversity  
```

Also talk about what the response matrix looks like going into these analyses.

```{r}
# get data into a matrix.......
# response matrix will be column number (Notes + 1) through EIR

# explanatory matrix will be column 1 through Notes
# vegetation zone is present, as is ortho height

# how to best restrict permutations? should i at all?

# and center/scale before calculating distance matrix????? or at least multiply EIR by 100 so it's on the same scale as the cover variables....


# null hypothesis is that the community is not changing through time
```

```{r stats-define-matrices}
# these were originally done with dat, not dat_multivar
# using dat_multivar GREATLY reduces the number of columns in the matrix
# and probably isn't what we want....  
expl <- dat_multivar[, 1:which(names(dat_multivar) == "Years_sinceStart")]
resp <- dat_multivar[, (1 + which(names(dat_multivar) == "Years_sinceStart")):which(names(dat_multivar) == "EIR")]

# probably need to scale up to at least namaste categories? e.g. wrack, dead, etc. plus total vegetated?

resp$EIR <- resp$EIR * 100  # put it on the same scale as the others

expl$Zone_Year <- paste(expl$Vegetation_Zone, expl$Year)

env <- expl %>% 
    select(Vegetation_Zone, Year,
           Zone_Year) %>% 
    mutate(across(everything(), as.factor))
```

## PERMANOVA

```{r mod-first-last-years}
# subset data frame to 'first two years' and 'last two years' (?) 
yrs_smpld <- sort(unique(expl$Year))
first_yrs <- yrs_smpld[c(1, 2)]
last_yrs <- yrs_smpld[c(length(yrs_smpld)-1, length(yrs_smpld))]

if(sum(first_yrs %in% last_yrs) > 0){
    print("Not enough years to compare 2 years at the beginning to 2 years at the end; only comparing first year to last year.")
    first_yrs <- first_yrs[1]
    last_yrs <- last_yrs[2]
}

# to only work with first and last years:
# use expl to index and subset both that and resp
fl_index <- which(expl$Year %in% c(first_yrs, last_yrs))
expl_pm <- expl[fl_index, ]
resp_pm <- resp[fl_index, ]

# give them a label for 'beginning' or 'end'
expl_pm$Time_group <- ifelse(expl_pm$Year %in% first_yrs, "Start", "End")
expl_pm$Zone_Timegroup <- paste(expl_pm$Vegetation_Zone, expl_pm$Time_group, sep = "; ")

env_pm <- expl_pm %>% 
    select(Vegetation_Zone, Time_group,
           Zone_Timegroup) %>% 
    mutate(across(everything(), as.factor))
```

```{r stats-run-permanova}
pmv <- adonis2(resp_pm ~ Vegetation_Zone*Time_group, data = expl_pm,
        method = "bray",
        permutations = 999)
pmv
```

Follow-up: which zones have experienced significant change? Start vs. End within each zone, don't need all pairwise comparisons.

`pairwiseAdonis` package is a wrapper for such comparisons but can only be installed [via GitHub](https://github.com/pmartinezarbizu/pairwiseAdonis), which is a problem for some NERR users.

And what are the species driving that change? (the latter will be answered by SIMPER)

```{r}
# mod <- metaMDS(resp_pm, trace = FALSE)
# plot(mod)
# ### Ellipsoid hulls show treatment
# with(expl_pm, ordiellipse(mod, Zone_Timegroup, kind = "ehull", label = TRUE, col = Zone_Timegroup))
# ### Spider shows fields
# with(expl_pm, ordispider(mod, Zone_Timegroup, lty=3, col="red"))
# 
# with(expl_pm, ordicluster(mod, Zone_Timegroup))
# 
# 
# 
# plot(mod)
# with(expl_pm, ordiellipse(mod, Zone_Timegroup, kind = "ehull", show.groups = c("T-Transition Beginning", "T-Transition End"), label = TRUE))
```

## SIMPER

```{r}

```

## NMDS

Again using only first 2 and last 2 years (or first and last only) - whatever combination was in the PERMANOVA. Using 3 dimensions for NMDS.

<details>

<summary>NMDS stress for each iteration</summary>

```{r stats-run-nmds}
mds_resp <- metaMDS(resp_pm, distance = "bray", k = 3,
                    autotransform = FALSE)
# plot(mds_resp, type = "t")

data.scores <- as.data.frame(scores(mds_resp)$sites)
species.scores <- as.data.frame(scores(mds_resp)$species)
species.scores$species <- rownames(species.scores) 

# only keep the species listed as reserve choices, to reduce clutter on graphic
species.scores <- species.scores %>% 
    filter(species %in% unique(anaSpec_list$multivar$Choice))

# data.scores$Vegetation_Zone <- expl$Vegetation_Zone
# data.scores$Year <- expl$Year
data.scores <- data.scores %>%
    mutate(Zone = expl_pm$Vegetation_Zone,
           Year = as.factor(expl_pm$Year),
           Time_group = as.factor(expl_pm$Time_group),
           Zone_Timegroup = as.factor(expl_pm$Zone_Timegroup)) %>% 
    separate(Zone, into = c("Zone_abbrev", "Zone_full"),
             sep = "-")
```

</details>

NMDS stress was `r round(mds_resp$stress, 4)`.

```{r stats-run-envfit}
en <- envfit(mds_resp, env_pm, permutations = 999)
en_coord_cat <-  as.data.frame(scores(en, "factors")) 

en_coord_cat <- en_coord_cat %>% 
    mutate(Factor = rownames(.)) %>% 
    filter(str_starts(Factor, "Zone_Timegroup")) %>% 
    mutate(Grp = str_remove(Factor, "Zone_Timegroup")) %>% 
    separate(Grp, into = c("Zone", "Time_group"),
             sep = "; ") %>% 
    separate(Zone, into = c("Zone_abbrev", "Zone_full"),
             sep = "-") %>% 
    mutate(Zone_Timegroup = paste(Zone_abbrev, Time_group))

```

```{r stats-graph-nmds}
# ggplot(data.scores, aes(x = NMDS1, y = NMDS2,
#                         col = Zone_abbrev)) +
#     geom_point(size = 2, alpha = 0.5) +
#     theme_bw() +
#     ggtitle("Ordination colored by Vegetation Zone")
# 
# ggplot(data.scores, aes(x = NMDS1, y = NMDS2,
#                         col = Time_group)) +
#     geom_point(size = 2, alpha = 0.5) +
#     theme_bw() +
#     ggtitle("Ordination colored by Time Period")
```

```{r}
# ggplot() +
#     geom_point(data = data.scores, aes(x = NMDS1, y = NMDS2,
#                                 col = Zone_abbrev,
#                                 shape = Time_group),
#                size = 2, alpha = 0.5) +
#     # geom_point(data = species.scores, aes(x = NMDS1, y = NMDS2),
#     #            col = "navyblue",
#     #            shape = "circle",
#     #            size = 4) +
#     geom_segment(data = species.scores, aes(
#         x = 0, y = 0,
#         xend = NMDS1, yend = NMDS2),
#         col = "navyblue",
#         arrow = arrow(),
#         linewidth = 0.8) +
#     geom_text_repel(data = species.scores, aes(x = NMDS1, y = NMDS2),
#                     label = species.scores$species,
#                     col = "navyblue",
#                     size = 3,
#                     fontface = "bold") +
#     theme_bw() +
#     ggtitle("Ordination colored by Vegetation Zone")
```

### NMDS Plot 

```{r stats-graph-nmds-centroids, fig.width = 7, fig.height = 7}
p <- ggplot() +
    geom_point(data = data.scores,
               aes(x = NMDS1, y = NMDS2,
                   col = Zone_abbrev),
               size = 1, alpha = 0.3) +
    geom_segment_interactive(data = species.scores, aes(
        x = 0, y = 0,
        xend = NMDS1, yend = NMDS2,
        tooltip = species),
        col = "black",
        arrow = arrow(),
        linewidth = 0.4) +
    geom_label_repel(data = species.scores, aes(x = NMDS1, y = NMDS2),
                    label = species.scores$species,
                    col = "black",
                    size = 3,
                    force_pull = 0.5,
                    force = 1.5,
                    label.size = NA,
                    label.padding = 0.1,
                    fill = alpha(c("white"),0.5)) +    
    geom_point_interactive(data = en_coord_cat, 
                           aes(x = NMDS1, y = NMDS2,
                               tooltip = Zone_Timegroup, data_id = Zone_Timegroup), 
                           shape = "diamond", 
                           size = 4, alpha = 0.8, colour = "navy") +
    geom_label_repel(data = en_coord_cat,
                    aes(x = NMDS1, y = NMDS2,
                        col = Zone_abbrev
                        ),
                    label = en_coord_cat$Zone_Timegroup,
                    size = 3,
                    fontface = "bold",
                    max.overlaps = 20,
                    min.segment.length = 0.1,
                    force = 1.5,
                    force_pull = 0.5,
                    label.size = NA,
                    label.padding = 0.2,
                    fill = alpha(c("white"),0.6)) +
    # theme_bw() +
    ggtitle("Ordination with Zone/Time centroids and Species arrows") +
    theme(legend.position = "none")

girafe(ggobj = p)
# geom_text_repel is not yet implemented in plotly
```

```{r}

```

Is the primary use for this plot going to be on-screen (interactive = good), or printed? - separate graphics.