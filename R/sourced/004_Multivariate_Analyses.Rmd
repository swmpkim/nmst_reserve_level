---
title: ''
output: html_document
---

```{r}
library(vegan)
library(ggrepel)
library(ggiraph)
```

## About  

These tabs are the multivariate analyses.  

**NOTE:** during development, I'm only using columns identified by reserves to highlight in their multivariate analyses. I'm not sure it's okay to ignore everything else - we probably should combine into Namaste categories and maybe some other things - so we need to discuss what the actual data frame will look like. The identified columns will still be the only ones that show up on species arrows and the like though.  

Need to write up some explanation of what we did statistically. Also identify which factors the reserve was interested in showing on NMDS plots.

```{r show-userChoice-multivar, results = 'asis'}
choices <- anaSpec_list$multivar$Choice
choices <- choices[!is.na(choices)]
cat("Up to 8 species/groups could be identified specifically in outputs of these multivariate analyses. Those identified were: \n")
cat(paste("*", choices), sep="\n")
```

```{r mod-multivar-df}
# widen out the univar data frame
# it's grouped appropriately for these analyses  
dat_multivar <- anaSpec_dfs$multivar %>% 
    pivot_wider(names_from = Species_or_Group,
                values_from = Cover)

# join EIR - use a join because might not be in same order
EIR_df <- dat %>% 
    select(StTrnsPlt, Year, Month, Day, EIR)
dat_multivar <- left_join(dat_multivar, EIR_df)

# can join any other metrics here - e.g. richness, diversity  
```

Also talk about what the response matrix looks like going into these analyses.

```{r}
# get data into a matrix.......
# response matrix will be column number (Notes + 1) through EIR

# explanatory matrix will be column 1 through Notes
# vegetation zone is present, as is ortho height

# how to best restrict permutations? should i at all?

# and center/scale before calculating distance matrix????? or at least multiply EIR by 100 so it's on the same scale as the cover variables....


# null hypothesis is that the community is not changing through time
```

```{r stats-define-matrices}
# these were originally done with dat, not dat_multivar
# using dat_multivar GREATLY reduces the number of columns in the matrix
# and probably isn't what we want....  
expl <- dat_multivar[, 1:which(names(dat_multivar) == "Years_sinceStart")]
resp <- dat_multivar[, (1 + which(names(dat_multivar) == "Years_sinceStart")):which(names(dat_multivar) == "EIR")]

# probably need to scale up to at least namaste categories? e.g. wrack, dead, etc. plus total vegetated?

resp$EIR <- resp$EIR * 100  # put it on the same scale as the others

expl$Zone_Year <- paste(expl$Vegetation_Zone, expl$Year)

env <- expl %>% 
    select(Vegetation_Zone, Year,
           Zone_Year) %>% 
    mutate(across(everything(), as.factor))
```

## PERMANOVA

```{r mod-first-last-years}
# subset data frame to 'first two years' and 'last two years' (?) 
yrs_smpld <- sort(unique(expl$Year))
first_yrs <- yrs_smpld[c(1, 2)]
last_yrs <- yrs_smpld[c(length(yrs_smpld)-1, length(yrs_smpld))]

if(sum(first_yrs %in% last_yrs) > 0){
    print("Not enough years to compare 2 years at the beginning to 2 years at the end; only comparing first year to last year.")
    first_yrs <- first_yrs[1]
    last_yrs <- last_yrs[2]
}

# to only work with first and last years:
# use expl to index and subset both that and resp
fl_index <- which(expl$Year %in% c(first_yrs, last_yrs))
expl_pm <- expl[fl_index, ]
resp_pm <- resp[fl_index, ]

# give them a label for 'beginning' or 'end'
expl_pm$Time_group <- ifelse(expl_pm$Year %in% first_yrs, "Start", "End")
expl_pm$Zone_Timegroup <- paste(expl_pm$Vegetation_Zone, expl_pm$Time_group, sep = "; ")

env_pm <- expl_pm %>% 
    select(Vegetation_Zone, Time_group,
           Zone_Timegroup) %>% 
    mutate(across(everything(), as.factor))
```

```{r stats-run-permanova}
pmv <- adonis2(resp_pm ~ Vegetation_Zone*Time_group, data = expl_pm,
        method = "bray",
        permutations = 999)
pmv
```

Follow-up: which zones have experienced significant change? Start vs. End within each zone, don't need all pairwise comparisons.

`pairwiseAdonis` package is a wrapper for such comparisons but can only be installed [via GitHub](https://github.com/pmartinezarbizu/pairwiseAdonis), which is a problem for some NERR users.

And what are the species driving that change? (the latter will be answered by SIMPER)

```{r}
# mod <- metaMDS(resp_pm, trace = FALSE)
# plot(mod)
# ### Ellipsoid hulls show treatment
# with(expl_pm, ordiellipse(mod, Zone_Timegroup, kind = "ehull", label = TRUE, col = Zone_Timegroup))
# ### Spider shows fields
# with(expl_pm, ordispider(mod, Zone_Timegroup, lty=3, col="red"))
# 
# with(expl_pm, ordicluster(mod, Zone_Timegroup))
# 
# 
# 
# plot(mod)
# with(expl_pm, ordiellipse(mod, Zone_Timegroup, kind = "ehull", show.groups = c("T-Transition Beginning", "T-Transition End"), label = TRUE))
```

## SIMPER

```{r}

```

## NMDS

Again using only first 2 and last 2 years (or first and last only) - whatever combination was in the PERMANOVA. Using 3 dimensions for NMDS.

<details>

<summary>NMDS stress for each iteration</summary>

```{r stats-run-nmds}
mds_resp <- metaMDS(resp_pm, distance = "bray", k = 3,
                    autotransform = FALSE)
# plot(mds_resp, type = "t")

data.scores <- as.data.frame(scores(mds_resp)$sites)
species.scores <- as.data.frame(scores(mds_resp)$species)
species.scores$species <- rownames(species.scores) 

# only keep the species listed as reserve choices, to reduce clutter on graphic
species.scores <- species.scores %>% 
    filter(species %in% unique(anaSpec_list$multivar$Choice))

# data.scores$Vegetation_Zone <- expl$Vegetation_Zone
# data.scores$Year <- expl$Year
data.scores <- data.scores %>%
    mutate(Zone = expl_pm$Vegetation_Zone,
           Year = as.factor(expl_pm$Year),
           Time_group = as.factor(expl_pm$Time_group),
           Zone_Timegroup = as.factor(expl_pm$Zone_Timegroup)) %>% 
    separate(Zone, into = c("Zone_abbrev", "Zone_full"),
             sep = "-")
```

</details>  



Final NMDS stress was `r round(mds_resp$stress, 4)`.


```{r}
# get centroids for each time/zone group
# https://stackoverflow.com/a/47523181
cent <- aggregate(cbind(NMDS1, NMDS2, NMDS3) ~ Zone_Timegroup, data = data.scores, FUN = mean)

en_coord_cat <- cent %>%
    separate(Zone_Timegroup, into = c("Zone", "Time_group"),
             sep = "; ") %>%
    separate(Zone, into = c("Zone_abbrev", "Zone_full"),
             sep = "-") %>%
    mutate(Zone_Timegroup = paste(Zone_abbrev, Time_group),
           Zone_Years = case_when(
               Time_group == "Start" ~ paste0(Zone_full, ": ", paste(first_yrs, collapse = ", ")),
               Time_group == "End" ~ paste0(Zone_full, ": ", paste(last_yrs, collapse = ", "))
               )
    )
```


```{r stats-run-envfit}
# get centroids for each group
# note this only works on first 2 NMDS axes

# en <- envfit(mds_resp, env_pm, permutations = 999)
# en_coord_cat <-  as.data.frame(scores(en, "factors")) 
# 
# en_coord_cat <- en_coord_cat %>% 
#     mutate(Factor = rownames(.)) %>% 
#     filter(str_starts(Factor, "Zone_Timegroup")) %>% 
#     mutate(Grp = str_remove(Factor, "Zone_Timegroup")) %>% 
#     separate(Grp, into = c("Zone", "Time_group"),
#              sep = "; ") %>% 
#     separate(Zone, into = c("Zone_abbrev", "Zone_full"),
#              sep = "-") %>% 
#     mutate(Zone_Timegroup = paste(Zone_abbrev, Time_group),
#            Zone_Years = case_when(
#                Time_group == "Start" ~ paste0(Zone_full, ": ", paste(first_yrs, collapse = ", ")),
#                Time_group == "End" ~ paste0(Zone_full, ": ", paste(last_yrs, collapse = ", "))
#                )
#     )

```

### NMDS Plot 


```{r stats-graph-nmds-centroids, fig.width = 6, fig.height = 6}
p <- plot_nmds()
girafe(ggobj = p)
# geom_text_repel is not yet implemented in plotly

p2 <- plot_nmds(axes = c(1, 3))
girafe(ggobj = p2)

p3 <- plot_nmds(axes = c(2, 3))
girafe(ggobj = p3)


# would like to add this caption but it's too long:
# "Navy diamonds represent the centroid for each Vegetation Zone/Time period combination. They are labelled with the Vegetation Zone abbreviation and 'Start' or 'End'. Upon hover, the full Vegetation Zone name and year(s) represented will be provided. Black arrows and text represent Species or Categories of vegetation. Hovering over the arrow will provide the Species or Category name. Points represent individual plots and are colored by Vegetation Zone; hovering does not yield output for points."
```


