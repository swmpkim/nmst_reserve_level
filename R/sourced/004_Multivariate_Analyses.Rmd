---
title: ''
output: html_document
---

```{r}
library(vegan)
library(ggrepel)
library(ggiraph)
```

## About  

These tabs are the multivariate analyses.  

In this section, we use ordination to visualize and analyze plant communities through plot-level cover data and explanatory variables (e.g., distance to water, elevation, salinity) across sites and marsh zones, when appropriate. Non-metric multidimensional scaling (NMDS) with loading factors (when appropriate) will be used to visualize the data. Loading factors can be key species or groupings (e.g., dominant species, bare, halophytes) or explanatory variables. We also plan to use  similarity analysis (SIMPER) to identify which cover categories are contributing to dissimilarity. A PERMANOVA incorporating appropriate explanatory variables (e.g., site, zone) will also be used to test for differences between years (test comparing first and last years may have the greatest power).

**NOTE:** during development, I'm only using columns identified by reserves to highlight in their multivariate analyses. I'm not sure it's okay to ignore everything else - we probably should combine into Namaste categories and maybe some other things - so we need to discuss what the actual data frame will look like. The identified columns will still be the only ones that show up on species arrows and the like though.  


### Questions addressed  

-  Are there shifts in the vegetation community (as defined by the entire percent-cover matrix) over time? Do these shifts vary by vegetation zone?  
    -  addressed with PERMANOVA, comparing first two and most recent two years of monitoring. (If there are <4 years of data, only the first and last year are compared)  
-  Which species/groups contribute most to these shifts?  
    -  addressed using SIMPER, comparing first and last year(s) of monitoring data within each zone. SIMPER is only used to follow up on vegetation zones that indicated a significant community difference in the PERMANOVA.  
-  Where is the plant community changing, and what characteristics do those areas have in common (e.g. site, zone, distance from water, elevation)?  
    -  visualized via NMDS.  

### Reserve output choices  

The following species/groups were identified by the reserve as important loading factors to display on NMDS outputs.  

```{r show-userChoice-multivar, results = 'asis'}
choices <- anaSpec_list$multivar$Choice
choices <- choices[!is.na(choices)]
cat("Up to 8 species/groups could be identified specifically in outputs of these multivariate analyses. Reserve choices are: \n")
```

```{r userChoice-2, results = 'asis'}
cat(paste("*", choices), sep="\n")
```


```{r mod-multivar-df}
# widen out the univar data frame
# it's grouped appropriately for these analyses  
dat_multivar <- anaSpec_dfs$multivar %>% 
    pivot_wider(names_from = Species_or_Group,
                values_from = Cover)

# join EIR - use a join because might not be in same order
EIR_df <- dat %>% 
    select(StTrnsPlt, Year, Month, Day, EIR)
dat_multivar <- left_join(dat_multivar, EIR_df)

# can join any other metrics here - e.g. richness, diversity  
```

```{r}
# get data into a matrix.......
# response matrix will be column number (Notes + 1) through EIR

# explanatory matrix will be column 1 through Notes
# vegetation zone is present, as is ortho height

# how to best restrict permutations? should i at all?

# and center/scale before calculating distance matrix????? or at least multiply EIR by 100 so it's on the same scale as the cover variables....


# null hypothesis is that the community is not changing through time
```

```{r stats-define-matrices}
# these were originally done with dat, not dat_multivar
# using dat_multivar GREATLY reduces the number of columns in the matrix
# and probably isn't what we want....  
expl <- dat_multivar[, 1:which(names(dat_multivar) == "Years_sinceStart")]
resp <- dat_multivar[, (1 + which(names(dat_multivar) == "Years_sinceStart")):which(names(dat_multivar) == "EIR")]

# probably need to scale up to at least namaste categories? e.g. wrack, dead, etc. plus total vegetated?

resp$EIR <- resp$EIR * 100  # put it on the same scale as the others

expl$Zone_Year <- paste(expl$Vegetation_Zone, expl$Year)

env <- expl %>% 
    select(Vegetation_Zone, Year,
           Zone_Year) %>% 
    mutate(across(everything(), as.factor))
```

## PERMANOVA

```{r mod-first-last-years}
# subset data frame to 'first two years' and 'last two years' (?) 
yrs_smpld <- sort(unique(expl$Year))
first_yrs <- yrs_smpld[c(1, 2)]
last_yrs <- yrs_smpld[c(length(yrs_smpld)-1, length(yrs_smpld))]

if(sum(first_yrs %in% last_yrs) > 0){
    print("Not enough years to compare 2 years at the beginning to 2 years at the end; only comparing first year to last year.")
    first_yrs <- first_yrs[1]
    last_yrs <- last_yrs[2]
}

# to only work with first and last years:
# use expl to index and subset both that and resp
fl_index <- which(expl$Year %in% c(first_yrs, last_yrs))
expl_pm <- expl[fl_index, ]
resp_pm <- resp[fl_index, ]

# give them a label for 'beginning' or 'end'
expl_pm$Time_group <- ifelse(expl_pm$Year %in% first_yrs, "Start", "End")
expl_pm$Zone_Timegroup <- paste(expl_pm$Vegetation_Zone, expl_pm$Time_group, sep = "; ")

env_pm <- expl_pm %>% 
    select(Vegetation_Zone, Time_group,
           Zone_Timegroup) %>% 
    mutate(across(everything(), as.factor))
```

```{r stats-run-permanova}
pmv <- adonis2(resp_pm ~ Vegetation_Zone*Time_group, data = expl_pm,
        method = "bray",
        permutations = 999)
pmv
```

Follow-up: which zones have experienced significant change? Start vs. End within each zone, don't need all pairwise comparisons.


And what are the species driving that change? (the latter will be answered by SIMPER)

```{r, results = 'asis'}
# for both follow-ups, want each zone on its own, start vs. end

zones <- unique(expl_pm$Vegetation_Zone)
pmvs <- list()
simps <- list()

for(i in seq_along(zones)){
    # subset data to this zone
    zn = zones[i]
    tmp_index <- which(expl_pm$Vegetation_Zone == zn)
    tmp_resp <- resp_pm[tmp_index, ]
    tmp_expl <- expl_pm[tmp_index, ]
    
    # run permanova
    pmvt <- adonis2(tmp_resp ~ Time_group, data = tmp_expl,
                    method = "bray")
    
    # save formatted output to list
    pmvs[[i]] <- broom::tidy(pmvt)
    names(pmvs)[[i]] <- zn
    
    # if permanova was significant, run SIMPER
    if(pmvt$`Pr(>F)`[row.names(pmvt) == "Time_group"] < 0.05){
        # run simper
        simp <- simper(tmp_resp, tmp_expl$Time_group)
        
        # format output
        simp_df <- summary(simp)$Start_End[1:6, c("average", "sd", "cumsum", "p")]
        simp_smaller <- data.frame(lapply(simp_df, round, 4))
        row.names(simp_smaller) <- row.names(simp_df)
        
        # save output to list
        simps[[i]] <- simp_smaller
        
        # if permanova wasn't significant, save a placeholder in the list   
    } else {
        simps[[i]] <- "No significant difference"
    }
    
    names(simps)[[i]] <- zn
}
```


### Post-hoc output  

Was there a community difference between "Start" (first 2 years) and "End" (last 2 years) for each zone?  


```{r}
print(pmvs)
```



## SIMPER  

If the PERMANOVA for a single zone had a significant p-value (p < 0.05), indicating a significant community change between the first and last years of monitoring, a SIMPER was performed. The top 6 species in output are below.  

"average" is the average contribution of that species to community differences (think of 0.10 as a 10% contribution); "sd" is the standard deviation. "cumsum" is the cumulative contribution for this species and all those above it in the table. Typically people only report species up to the one that brings "cumsum" over 0.7. p" is a p-value for that species based on permutation tests.  

```{r}
print(simps)
```

## NMDS


<details>

<summary>NMDS stress for each iteration</summary>

```{r stats-run-nmds}
mds_resp <- metaMDS(resp_pm, distance = "bray", k = 3,
                    autotransform = FALSE)
# plot(mds_resp, type = "t")

data.scores <- as.data.frame(scores(mds_resp)$sites)
species.scores <- as.data.frame(scores(mds_resp)$species)
species.scores$species <- rownames(species.scores) 

# only keep the species listed as reserve choices, to reduce clutter on graphic
species.scores <- species.scores %>% 
    filter(species %in% unique(anaSpec_list$multivar$Choice))

# data.scores$Vegetation_Zone <- expl$Vegetation_Zone
# data.scores$Year <- expl$Year
data.scores <- data.scores %>%
    mutate(Zone = expl_pm$Vegetation_Zone,
           Year = as.factor(expl_pm$Year),
           Time_group = as.factor(expl_pm$Time_group),
           Zone_Timegroup = as.factor(expl_pm$Zone_Timegroup)) %>% 
    separate(Zone, into = c("Zone_abbrev", "Zone_full"),
             sep = "-")
```

</details>  

***  

Final 3-dimensional NMDS stress was `r round(mds_resp$stress, 4)`.  

#### How to read these NMDS plots  

-  Navy diamonds represent the centroid for each Vegetation Zone/Time period combination. They are labelled with the Vegetation Zone abbreviation and 'Start' or 'End'. Upon hover, the full Vegetation Zone name and year(s) represented will be provided.  
-  Black arrows and text represent Species or Categories of vegetation (e.g. H-Halophyte). Hovering over the arrow will provide the Species or Category name.  
-  Points represent individual plots and are colored by Vegetation Zone; hovering does not yield output for points.


```{r}
# get centroids for each time/zone group
# https://stackoverflow.com/a/47523181
cent <- aggregate(cbind(NMDS1, NMDS2, NMDS3) ~ Zone_Timegroup, data = data.scores, FUN = mean)

en_coord_cat <- cent %>%
    separate(Zone_Timegroup, into = c("Zone", "Time_group"),
             sep = "; ") %>%
    separate(Zone, into = c("Zone_abbrev", "Zone_full"),
             sep = "-") %>%
    mutate(Zone_Timegroup = paste(Zone_abbrev, Time_group),
           Zone_Years = case_when(
               Time_group == "Start" ~ paste0(Zone_full, ": ", paste(first_yrs, collapse = ", ")),
               Time_group == "End" ~ paste0(Zone_full, ": ", paste(last_yrs, collapse = ", "))
               )
    )
```



```{r stats-graph-nmds-centroids, fig.width = 7, fig.height = 7}
p <- plot_nmds()
girafe(ggobj = p,
       width_svg = 6,
       height_svg = 5,
       width = 0.8,
       height = 0.6
       )
# geom_text_repel is not yet implemented in plotly

p2 <- plot_nmds(axes = c(1, 3))
girafe(ggobj = p2,
       width_svg = 6,
       height_svg = 5,
       width = 0.8,
       height = 0.6)

p3 <- plot_nmds(axes = c(2, 3))
girafe(ggobj = p3,
       width_svg = 6,
       height_svg = 5,
       width = 0.8,
       height = 0.6)

```


